<!DOCTYPE html>
<html>
<head>
  <title>Twitch Hype Train Indicator</title>
</head>
<body>
  <canvas id="myCanvas" width="400" height="400"></canvas>

  <script>
    // Define your Twitch API client ID and redirect URI
    const clientId = '8p069a6yd66co1xpzq2pmhrx0ykqxx';
    const redirectUri = 'https://custom-hypetrain.vercel.app/';
    let allContrubutions = [];

    // Canvas setup
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1920;
    canvas.height = 1080;

    // Function to handle the OAuth 2.0 authentication flow
    function authenticateWithTwitch() {
      // Define the authorization URL
      const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=channel:read:hype_train`;

      // Redirect the user to Twitch for authentication
      window.location.href = authUrl;
    }

    function getUsername(accessToken, userId) {
      // Make an API request to the Twitch helix users endpoint to get the username
      fetch(`https://api.twitch.tv/helix/users?id=${userId}`, {
        headers: {
          'Client-ID': clientId,
          'Authorization': `Bearer ${accessToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.data.length > 0) {
          return data.data[0].login;
        } else {
          console.log('User not found');
        }
      })
      .catch(error => {
        console.error('Error fetching username:', error);
      });
    }
    
    function updateUserNames(accessToken){
      for (var i=0; i<contributors.length; i++){
        allContrubutions[i].username = getUsername(accessToken, contributors[i].userId);
      }

      const webhookUrl = "https://discord.com/api/webhooks/1148340655840579615/sM8hKS4Pv_lNxwGMWY1RS46kp523-nyclpOY3Z6zaHbysVRFJK9V0TUeLeGLRQCzZaiO";
      const message = 'All contributors: ' + JSON.stringify(allContrubutions);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', webhookUrl, true);
      xhr.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');
      const payload = JSON.stringify({
        content: message,
      });
      xhr.send(payload);
    }

    // Function to make an API request to get user information
    function getUserInfo(accessToken) {
      // Make an API request to the Twitch helix users endpoint
      fetch('https://api.twitch.tv/helix/users', {
        headers: {
          'Client-ID': clientId,
          'Authorization': `Bearer ${accessToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log('User Info:', data);
        // Check for an active Hype Train
        setInterval(function() {
          checkHypeTrain(accessToken, data.data[0].id)
        }, 2000);

        setInterval(function(){
          updateUserNames(accessToken, allContrubutions);
        }, 15000);
      })
      .catch(error => {
        console.error('Error fetching user info:', error);
      });
    }

    // Function to check for an active Hype Train
    function checkHypeTrain(accessToken, userId) {
      // Make an API request to the Twitch helix hype train events endpoint
      fetch(`https://api.twitch.tv/helix/hypetrain/events?broadcaster_id=${userId}`, {
        headers: {
          'Client-ID': clientId,
          'Authorization': `Bearer ${accessToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.data.length > 0) {
            console.log('Active Hype Train:', data);
            lastUser = data.data[0].event_data.last_contribution.user;
            if (allContrubutions.includes(lastUser) == false) {
              allContrubutions[lastUser] = {'userId': lastUser, 'username': ''};
            }
        } else {
          console.log('No active Hype Train');
          topContributionsHistory = {};
        }
      })
      .catch(error => {
        console.error('Error checking Hype Train:', error);
      });
    }

    // Check if the page has been redirected from Twitch with an access token
    if (window.location.hash) {
      const accessToken = window.location.hash.substring(1).split('&')[0].split('=')[1];
      getUserInfo(accessToken);
     
    } else {
      // If not redirected, initiate the authentication flow
      authenticateWithTwitch();
    }
  </script>
</body>
</html>