<!DOCTYPE html>
<html>
<head>
  <title>Twitch Hype Train Indicator</title>
</head>
<body>
  <canvas id="myCanvas" width="400" height="400"></canvas>

  <script>
    // Define your Twitch API client ID and redirect URI
    const clientId = '8p069a6yd66co1xpzq2pmhrx0ykqxx';
    const redirectUri = 'https://custom-hypetrain.vercel.app/';
    let allContrubutions = [];

    // Canvas setup
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1920;
    canvas.height = 1080;

    // Function to handle the OAuth 2.0 authentication flow
    function authenticateWithTwitch() {
      // Define the authorization URL
      const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=channel:read:hype_train`;

      // Redirect the user to Twitch for authentication
      window.location.href = authUrl;
    }

    function getUsername(accessToken, userId) {
      // Make an API request to the Twitch helix users endpoint to get the username
      fetch(`https://api.twitch.tv/helix/users?id=${userId}`, {
        headers: {
          'Client-ID': clientId,
          'Authorization': `Bearer ${accessToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.data.length > 0) {
          const username = data.data[0].login;
          console.log('Username:', username);
          return username;
          // Now you have the username, and you can use it as needed
        } else {
          console.log('User not found');
        }
      })
      .catch(error => {
        console.error('Error fetching username:', error);
      });
    }

    // Function to make an API request to get user information
    function getUserInfo(accessToken) {
      // Make an API request to the Twitch helix users endpoint
      fetch('https://api.twitch.tv/helix/users', {
        headers: {
          'Client-ID': clientId,
          'Authorization': `Bearer ${accessToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log('User Info:', data);
        // Check for an active Hype Train
        setInterval(function() {
          checkHypeTrain(accessToken, data.data[0].id)
        }, 5000);
      })
      .catch(error => {
        console.error('Error fetching user info:', error);
      });
    }

    // Function to check for an active Hype Train
    function checkHypeTrain(accessToken, userId) {
      // Make an API request to the Twitch helix hype train events endpoint
      fetch(`https://api.twitch.tv/helix/hypetrain/events?broadcaster_id=${userId}`, {
        headers: {
          'Client-ID': clientId,
          'Authorization': `Bearer ${accessToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.data.length > 0) {
            console.log('Active Hype Train:', data);
            lastUser = getUsername(accessToken, data.data[0].event_data.last_contribution.user);
            if (!in_array(lastUser, allContrubutions)) {
              allContrubutions.push(lastUser);
            }

            console.log(allContrubutions);
        } else {
          console.log('No active Hype Train');
          topContributionsHistory = {};
        }
      })
      .catch(error => {
        console.error('Error checking Hype Train:', error);
      });
    }

    // Check if the page has been redirected from Twitch with an access token
    if (window.location.hash) {
      const accessToken = window.location.hash.substring(1).split('&')[0].split('=')[1];
      getUserInfo(accessToken);
     
    } else {
      // If not redirected, initiate the authentication flow
      authenticateWithTwitch();
    }
  </script>
</body>
</html>