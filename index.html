<!DOCTYPE html>
<html>
<head>
  <title>Twitch Hype Train Indicator</title>
</head>
<body>
  <canvas id="myCanvas" width="400" height="400"></canvas>

  <script>
    // Define your Twitch API client ID and redirect URI
    const clientId = '8p069a6yd66co1xpzq2pmhrx0ykqxx';
    const redirectUri = 'https://custom-hypetrain.vercel.app/';

    // Canvas setup
    const canvas = document.getElementById('myCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 400;
    canvas.height = 400;

    // Function to handle the OAuth 2.0 authentication flow
    function authenticateWithTwitch() {
      // Define the authorization URL
      // https://id.twitch.tv/oauth2/authorize?response_type=code&client_id=gp762nuuoqcoxypju8c569th9wz7q5&redirect_uri=https://twitchtokengenerator.com&scope=channel:read:hype_train+user:read:subscriptions&state=frontend|U0FaQnZMak9UZmdIT3pIeVBEd1E4QT09&force_verify=true
      const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=token&scope=channel:read:hype_train+user:read:subscriptions`;

      // Redirect the user to Twitch for authentication
      window.location.href = authUrl;
    }

    // Function to make an API request to get user information
    function getUserInfo(accessToken) {
      // Make an API request to the Twitch helix users endpoint
      fetch('https://api.twitch.tv/helix/users', {
        headers: {
          'Client-ID': clientId,
          'Authorization': `Bearer ${accessToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log('User Info:', data);

        // Check for an active Hype Train
        checkHypeTrain(accessToken, data.data[0].id);
      })
      .catch(error => {
        console.error('Error fetching user info:', error);
      });
    }

    // Function to check for an active Hype Train
    function checkHypeTrain(accessToken, userId) {
      // Make an API request to the Twitch helix hype train events endpoint
      fetch(`https://api.twitch.tv/helix/hypetrain/events?broadcaster_id=${userId}`, {
        headers: {
          'Client-ID': clientId,
          'Authorization': `Bearer ${accessToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.data.length > 0) {
          console.log('Active Hype Train:', data);

          // Draw a yellow circle on the canvas
          ctx.fillStyle = 'yellow';
          ctx.beginPath();
          ctx.arc(200, 200, 50, 0, Math.PI * 2);
          ctx.fill();
          ctx.closePath();
        } else {
          console.log('No active Hype Train');
          // Clear the canvas if no active Hype Train
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          const img = new Image();
          img.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='100' viewBox='0 0 200 100'%3E%3Crect x='20' y='30' width='160' height='40' fill='blue' /%3E%3Crect x='30' y='35' width='30' height='20' fill='white' /%3E%3Crect x='70' y='35' width='30' height='20' fill='white' /%3E%3Crect x='110' y='35' width='30' height='20' fill='white' /%3E%3Crect x='150' y='35' width='30' height='20' fill='white' /%3E%3Ccircle cx='50' cy='80' r='10' fill='black' /%3E%3Ccircle cx='150' cy='80' r='10' fill='black' /%3E%3C/svg%3E";
          img.onload = function() {
            ctx.drawImage(img, 0, 0);
          };

        }
      })
      .catch(error => {
        console.error('Error checking Hype Train:', error);
      });
    }

    // Check if the page has been redirected from Twitch with an access token
    if (window.location.hash) {
      const accessToken = window.location.hash.substring(1).split('&')[0].split('=')[1];
      getUserInfo(accessToken);
    } else {
      // If not redirected, initiate the authentication flow
      authenticateWithTwitch();
    }
  </script>
</body>
</html>